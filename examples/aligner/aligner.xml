<?xml version="1.0"?>
<hml debug="no">

<alphabet id="nucleotides">
 ACGT
</alphabet>

<!--  Definition of the output "tapes"  -->
<output id="sequence">
 <alphabet idref="nucleotides"/>
 <identifier type="length" value="iLen"/>
 <identifier type="sequence" value="iSequence"/>
 <code type="parameter">
  <![CDATA[
     vector<char>& iSequence
  ]]>
 </code>
</output>

<code id="initialise1" type="statement">
  <![CDATA[

  int iLen = iSequence.size();

  unsigned char iTranslate[256];
  for (int i=0; i<256; i++) {
    iTranslate[i]= 0;
  }
  iTranslate[(unsigned)'A'] = 0;   // It is important that this is in alphabetical order, to
  iTranslate[(unsigned)'a'] = 0;   // make the indices correspond to those used for Baum-Welch
  iTranslate[(unsigned)'C'] = 1;
  iTranslate[(unsigned)'c'] = 1;
  iTranslate[(unsigned)'G'] = 2;
  iTranslate[(unsigned)'g'] = 2;
  iTranslate[(unsigned)'T'] = 3;
  iTranslate[(unsigned)'t'] = 3;
  ]]>
</code>

<code id="initialise2" type="statement">
  <code type="parameter"> double tau </code>    <!-- length parameter -->
  <code type="parameter"> double go_dishonest </code> <!-- rate G1 to G2 -->
  <code type="parameter"> double go_honest </code> <!-- rate G2 to G1 -->
  <![CDATA[

  map<string,double> m_trans; // transition matrix
  m_trans["b_h"]  = 1;
  m_trans["b_d"]  = 0;
  m_trans["h_h"] = 1 - go_dishonest - tau;
  m_trans["h_d"] = go_dishonest;
  m_trans["d_d"] = 1 - go_honest - tau;
  m_trans["d_h"] = go_honest;
  m_trans["h_s"]  = tau;
  m_trans["d_s"]  = tau;

  ]]>
</code>

<!-- NOTE: hmmoc's parser barfs on the comma in map<string, vector<double> >, so I sed through and  -->
<!-- replace the XcommaX later (see makefile). TODO fix that shit. -->
<probability id="honest_emission_prob">
  <code type="statement" init="initialise1">
    <identifier output="sequence" value="iSymb"/>
    <identifier type="result" value="iPP"/>
    <code type="parameter"> <![CDATA[ map<stringXcommaXvector<double> > emission_probs ]]> </code>
    <![CDATA[
      iPP = emission_probs["honest"][ iTranslate[ iSymb ] ];
    ]]>
  </code>
</probability>
<probability id="dishonest_emission_prob">
  <code type="statement" init="initialise1">
    <identifier output="sequence" value="iSymb"/>
    <identifier type="result" value="iPP"/>
    <code type="parameter"> <![CDATA[ map<stringXcommaXvector<double> > emission_probs ]]> </code>
    <![CDATA[
      iPP = emission_probs["dishonest"][ iTranslate[ iSymb ] ];
    ]]>
  </code>
</probability>

<probability id="prob_b_h"><code type="expression" init="initialise2"> m_trans["b_h"] </code></probability>
<probability id="prob_b_d"><code type="expression" init="initialise2"> m_trans["b_d"] </code></probability>
<probability id="prob_h_h"><code type="expression" init="initialise2"> m_trans["h_h"] </code></probability>
<probability id="prob_h_d"><code type="expression" init="initialise2"> m_trans["h_d"] </code></probability>
<probability id="prob_d_d"><code type="expression" init="initialise2"> m_trans["d_d"] </code></probability>
<probability id="prob_d_h"><code type="expression" init="initialise2"> m_trans["d_h"] </code></probability>
<probability id="prob_h_s"><code type="expression" init="initialise2"> m_trans["h_s"] </code></probability>
<probability id="prob_d_s"><code type="expression" init="initialise2"> m_trans["d_s"] </code></probability>

<hmm id="SeqGen">
 <description> random sequence genera	tor </description>
 <outputs id="outputs">
  <output idref="sequence"/>
 </outputs>
 <clique id="block1">
  <state id="begin"/>
 </clique>
 <clique id="block2">
  <state id="honest"/>
  <state id="dishonest"/>
 </clique>
 <clique id="block3">
  <state id="stop"/>
 </clique>
 <graph>
  <clique idref="block1"/>
  <clique idref="block2"/>
  <clique idref="block3"/>
 </graph>

  <emission id="honest_emission">
   <output idref="sequence"/>
   <probability idref="honest_emission_prob"/>
  </emission>
  <emission id="dishonest_emission">
   <output idref="sequence"/>
   <probability idref="dishonest_emission_prob"/>
  </emission>
  <emission id="empty">
   <probability>
    <code type="expression"> 1.0 </code>
   </probability>
  </emission>

  <transitions id="transitions">
  <transition id="tr_b_h" from="begin"     to="honest"    probability="prob_b_h" emission="honest_emission"/>
  <transition id="tr_b_d" from="begin"     to="dishonest" probability="prob_b_d" emission="dishonest_emission"/>
  <transition id="tr_h_h" from="honest"    to="honest"    probability="prob_h_h" emission="honest_emission"/>
  <transition id="tr_h_d" from="honest"    to="dishonest" probability="prob_h_d" emission="dishonest_emission"/>
  <transition id="tr_d_d" from="dishonest" to="dishonest" probability="prob_d_d" emission="dishonest_emission"/>
  <transition id="tr_d_h" from="dishonest" to="honest"    probability="prob_d_h" emission="honest_emission"/>
  <transition id="tr_h_s" from="honest"    to="stop"      probability="prob_h_s" emission="empty"/>
  <transition id="tr_d_s" from="dishonest" to="stop"      probability="prob_d_s" emission="empty"/>
  </transitions>
</hmm>

<hmm id="NESeqGen">
 <description> random sequence generator without emissions (for sampling) </description>
 <outputs/>
 <clique id="NEblock1">
  <state id="NEbegin"/>
 </clique>
 <clique id="NEblock2">
  <state id="NEhonest"/>
  <state id="NEdishonest"/>
 </clique>
 <clique id="NEblock3">
  <state id="NEstop"/>
 </clique>
 <graph>
  <clique idref="NEblock1"/>
  <clique idref="NEblock2"/>
  <clique idref="NEblock3"/>
 </graph>

  <emission id="NEempty">
   <probability>
    <code type="expression"> 1.0 </code>
   </probability>
  </emission>

  <transitions id="NEtransitions">
  <transition from="NEbegin"     to="NEhonest"    probability="prob_b_h" emission="NEempty"/>
  <transition from="NEbegin"     to="NEdishonest" probability="prob_b_d" emission="NEempty"/>
  <transition from="NEhonest"    to="NEhonest"    probability="prob_h_h" emission="NEempty"/>
  <transition from="NEhonest"    to="NEdishonest" probability="prob_h_d" emission="NEempty"/>
  <transition from="NEdishonest" to="NEdishonest" probability="prob_d_d" emission="NEempty"/>
  <transition from="NEdishonest" to="NEhonest"    probability="prob_d_h" emission="NEempty"/>
  <transition from="NEhonest"    to="NEstop"      probability="prob_h_s" emission="NEempty"/>
  <transition from="NEdishonest" to="NEstop"      probability="prob_d_s" emission="NEempty"/>
  </transitions>
</hmm>

<!-- Code generation -->
<!-- No emission hmm -->
<backward  outputTable="yes" name="NEBackward" id="nebw">
  <hmm idref="NESeqGen"/>
</backward>
<sample  name="NESample" id="nesmp">
  <hmm idref="NESeqGen"/>
</sample>
<!-- Regular emission hmm -->
<forward outputTable="yes" baumWelch="no" name="Forward" id="fw">
  <hmm idref="SeqGen"/>
</forward>
<backward outputTable="yes" baumWelch="yes" name="Backward" id="bw">
  <!-- NOTE: outputTable was "no" in the original example, and it seemed to work... but if it's "no" -->
  <!-- here it breaks the baum welch counters. I don't know why. -->
  <hmm idref="SeqGen"/>
</backward>
<viterbi name="Viterbi" id="vit" outputTable="yes">
  <hmm idref="SeqGen"/>
</viterbi>

<codeGeneration realtype="bfloat" file="aligner.cc" header="aligner.h" language="C++">
  <backward idref="nebw"/>
  <sample idref="nesmp"/>
  <forward idref="fw"/>
  <backward idref="bw"/>
  <viterbi idref="vit"/>
</codeGeneration>

</hml>
