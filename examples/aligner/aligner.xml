<?xml version="1.0"?>
<hml debug="yes">
<author> Gerton Lunter </author>

<alphabet id="nucleotides">
 ACGT
</alphabet>

<!--  Definition of the output "tapes"  -->
<output id="sequence">
 <alphabet idref="nucleotides"/>
 <identifier type="length" value="iLen"/>
 <identifier type="sequence" value="iSequence"/>
 <code type="parameter">
  <![CDATA[
     vector<char>& iSequence
  ]]>
 </code>
</output>

<code id="initialise1" type="statement">
  <![CDATA[

  int iLen = iSequence.size();

  unsigned char iTranslate[256];
  for (int i=0; i<256; i++) {
    iTranslate[i]= 0;
  }
  iTranslate[(unsigned)'A'] = 0;   // It is important that this is in alphabetical order, to
  iTranslate[(unsigned)'a'] = 0;   // make the indices correspond to those used for Baum-Welch
  iTranslate[(unsigned)'C'] = 1;
  iTranslate[(unsigned)'c'] = 1;
  iTranslate[(unsigned)'G'] = 2;
  iTranslate[(unsigned)'g'] = 2;
  iTranslate[(unsigned)'T'] = 3;
  iTranslate[(unsigned)'t'] = 3;

  double emitProbs1[4];
  emitProbs1[0] = 0.1;
  emitProbs1[1] = 0.1;
  emitProbs1[2] = 0.4;
  emitProbs1[3] = 0.4;
  double emitProbs2[4];
  emitProbs2[0] = 0.1;
  emitProbs2[1] = 0.4;
  emitProbs2[2] = 0.1;
  emitProbs2[3] = 0.4;

  ]]>
</code>

<!-- <probability id="one"><code> 1.0 </code></probability> -->
<probability id="emissionProb1">
  <code type="statement" init="initialise1">
    <identifier output="sequence" value="iSymb"/>
    <identifier type="result" value="iPP"/>
    <![CDATA[
      iPP = emitProbs1[ iTranslate[ iSymb ] ];
    ]]>
  </code>
</probability>
<probability id="emissionProb2">
  <code type="statement" init="initialise1">
    <identifier output="sequence" value="iSymb"/>
    <identifier type="result" value="iPP"/>
    <![CDATA[
      iPP = emitProbs2[ iTranslate[ iSymb ] ];
    ]]>
  </code>
</probability>

<probability id="probBG1"><code  type="expression"> 0.5 </code></probability>
<probability id="probBG2"><code  type="expression"> 0.5 </code></probability>
<probability id="probG1G1"><code type="expression"> 0.99/2 </code></probability>
<probability id="probG1G2"><code type="expression"> 0.99/2 </code></probability>
<probability id="probG2G2"><code type="expression"> 0.99/2 </code></probability>
<probability id="probG2G1"><code type="expression"> 0.99/2 </code></probability>
<probability id="probG1S"><code  type="expression"> 0.01 </code></probability>
<probability id="probG2S"><code  type="expression"> 0.01 </code></probability>

<hmm id="SeqGen">
 <description> random sequence generator </description>
 <outputs id="outputs">
  <output idref="sequence"/>
 </outputs>
 <clique id="block1">
  <state id="begin"/>
  <state id="generate1"/>
  <state id="generate2"/>
  <state id="stop"/>
 </clique>
 <graph>
  <clique idref="block1"/>
 </graph>

  <emission id="emit1">
   <output idref="sequence"/>
   <probability idref="emissionProb1"/>
  </emission>
  <emission id="emit2">
   <output idref="sequence"/>
   <probability idref="emissionProb2"/>
  </emission>
  <emission id="empty">
   <probability>
    <code type="expression"> 1.0 </code>
   </probability>
  </emission>

  <transitions id="transitions">
  <transition id="trBG1"  from="begin"     to="generate1" probability="probBG1"  emission="emit1"/>
  <transition id="trBG2"  from="begin"     to="generate2" probability="probBG2"  emission="emit2"/>
  <transition id="trG1G1" from="generate1" to="generate1" probability="probG1G1" emission="emit1"/>
  <transition id="trG1G2" from="generate1" to="generate2" probability="probG1G2" emission="emit2"/>
  <transition id="trG2G2" from="generate2" to="generate2" probability="probG2G2" emission="emit2"/>
  <transition id="trG2G1" from="generate2" to="generate1" probability="probG2G1" emission="emit1"/>
  <transition id="trG1S"  from="generate1" to="stop"      probability="probG1S"   emission="empty"/>
  <transition id="trG2S"  from="generate2" to="stop"      probability="probG2S"   emission="empty"/>
  </transitions>
</hmm>

<!-- Code generation -->
<viterbi name="Viterbi" id="vit" outputTable="yes">
  <hmm idref="SeqGen"/>
</viterbi>

<codeGeneration realtype="bfloat" file="aligner.cc" header="aligner.h" language="C++">
  <viterbi idref="vit"/>
</codeGeneration>

</hml>
